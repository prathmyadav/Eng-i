<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"> {/* Mobile friendly */}
    <title>Smart Grocery Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Material+Icons+Sharp&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme */
            --primary-color: #1a73e8; 
            --primary-dark-color: #1255a7;
            --accent-color: #4285f4; 
            --secondary-color: #34a853; 
            --danger-color: #ea4335;   
            
            --background-color: #f8f9fa; 
            --surface-color: #ffffff;
            --on-surface-color: #202124; 
            --on-surface-variant-color: #5f6368; 
            --outline-color: #dadce0; 
            --hover-bg-light: rgba(0,0,0,0.04);
            --primary-color-rgb: 26, 115, 232;
            --danger-color-rgb: 234, 67, 53;

            --status-error-bg: #fdeded;
            --status-error-border: #f5c6cb;
            --status-success-bg: #e6f4ea;
            --status-success-border: #c3e6cb;
            --status-info-bg: #e7f3fe;
            --status-info-border: #b8daff;

            --category-tab-hover-bg: #e8f0fe;
            --category-tab-active-text: white;


            --font-family: 'Roboto', sans-serif;
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 24px;
            --box-shadow-soft: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            --box-shadow-strong: 0 3px 6px rgba(0,0,0,0.1), 0 3px 6px rgba(0,0,0,0.15);
        }

        html.dark-mode {
            --primary-color: #8ab4f8; 
            --primary-dark-color: #669DF6;
            --accent-color: #82b1ff; 
            --secondary-color: #81c995; 
            --danger-color: #f28b82;   
            
            --background-color: #202124; 
            --surface-color: #303134;
            --on-surface-color: #e8eaed; 
            --on-surface-variant-color: #bdc1c6; 
            --outline-color: #5f6368; 
            --hover-bg-light: rgba(255,255,255,0.08);
            --primary-color-rgb: 138, 180, 248;
            --danger-color-rgb: 242, 139, 130;

            --status-error-bg: #442b2a;
            --status-error-border: #7d3e39;
            --status-success-bg: #2a3b2f;
            --status-success-border: #3a6243;
            --status-info-bg: #28354c;
            --status-info-border: #385898;

            --category-tab-hover-bg: #3a3f50;
            --category-tab-active-text: #202124; 
        }


        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--on-surface-color);
            line-height: 1.5;
            display: flex;
            flex-direction: column; 
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        .material-icons-sharp {
            font-family: 'Material Icons Sharp';
            font-weight: normal;
            font-style: normal;
            font-size: 24px; 
            display: inline-block;
            line-height: 1;
            text-transform: none;
            letter-spacing: normal;
            word-wrap: normal;
            white-space: nowrap;
            direction: ltr;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            -moz-osx-font-smoothing: grayscale;
            font-feature-settings: 'liga';
            vertical-align: middle; 
        }

        .app-container {
            width: 100%;
            max-width: 720px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow-strong);
            margin: 15px;
            overflow: hidden; 
            display: flex;
            flex-direction: column;
            height: calc(100vh - 30px);
        }
        @media (max-width: 600px) {
            .app-container {
                margin: 0;
                border-radius: 0;
                height: 100vh;
            }
        }


        .app-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--outline-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-header h1 {
            font-size: 1.5em; 
            font-weight: 500;
            color: var(--on-surface-color);
            flex-grow: 1; 
        }

        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--on-surface-variant-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s, color 0.2s;
        }
        .theme-toggle-btn:hover {
            background-color: var(--hover-bg-light);
        }
        
        .budget-area {
            padding: 10px 16px;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--outline-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9em;
            flex-wrap: wrap;
        }
        .budget-area label {
            font-weight: 500;
            color: var(--on-surface-variant-color);
        }
        .budget-area input[type="number"] {
            padding: 6px 8px;
            border: 1px solid var(--outline-color);
            border-radius: var(--border-radius-sm);
            width: 100px; 
            background-color: var(--background-color); 
            color: var(--on-surface-color);
            outline-color: var(--primary-color);
        }
        #totalCostDisplay {
            font-weight: 500;
            margin-left: auto; 
            color: var(--on-surface-color);
        }
        #budgetStatusDisplay {
            font-weight: 500;
            min-width: 140px; 
            text-align: right;
            font-size: 0.95em;
        }
        
        .app-content {
            padding: 0 0 20px 0; 
            flex-grow: 1;
            overflow-y: auto;
        }

        .input-area-wrapper {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--outline-color);
        }
        .input-bar {
            display: flex;
            align-items: center;
            padding: 12px 16px; 
        }

        .input-field-container {
            flex-grow: 1;
            display: flex;
            align-items: center;
            background-color: var(--background-color); 
            border-radius: var(--border-radius-lg); 
            padding: 2px 6px 2px 14px; 
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.075);
            margin-right: 10px;
        }
        html.dark-mode .input-field-container {
             box-shadow: inset 0 1px 2px rgba(0,0,0,0.2);
        }

        .input-field-container input[type="text"] {
            flex-grow: 1;
            border: none;
            outline: none;
            background-color: transparent;
            font-size: 1em; 
            color: var(--on-surface-color);
            padding: 10px 0; 
        }
        .input-field-container input[type="text"]::placeholder {
            color: var(--on-surface-variant-color);
            opacity: 0.7;
        }

        .voice-input-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .voice-input-btn:hover, .voice-input-btn:focus {
            background-color: rgba(var(--primary-color-rgb), 0.1); 
        }
        .voice-input-btn.listening .material-icons-sharp {
            color: var(--danger-color); 
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        .add-item-btn-main {
            background-color: var(--primary-color);
            color: var(--category-tab-active-text);
            border: none;
            padding: 10px 16px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-weight: 500;
            font-size: 0.9em;
            transition: background-color 0.2s, box-shadow 0.2s;
            box-shadow: var(--box-shadow-soft);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .add-item-btn-main .material-icons-sharp { font-size: 1.2em; }
        .add-item-btn-main:hover, .add-item-btn-main:focus {
            background-color: var(--primary-dark-color);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .advanced-input-options {
            padding: 12px 16px 16px;
            background-color: var(--surface-color); 
            display: none; 
            animation: slideDown 0.3s ease-out forwards; 
        }
        @keyframes slideDown { 
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }
        .option-group {
            display: flex;
            flex-direction: column;
        }
        .option-group label {
            font-size: 0.8em;
            color: var(--on-surface-variant-color);
            margin-bottom: 4px;
            font-weight: 500;
        }
        .option-group input[type="number"], .option-group select {
            padding: 8px 10px;
            border: 1px solid var(--outline-color);
            border-radius: var(--border-radius-sm);
            font-size: 0.95em;
            background-color: var(--background-color);
            color: var(--on-surface-color);
            outline-color: var(--primary-color);
        }
        
        .category-suggestion-tabs label {
            font-size: 0.8em;
            color: var(--on-surface-variant-color);
            margin-bottom: 6px;
            display: block;
            font-weight: 500;
        }
        .category-suggestion-tabs .tabs-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .category-tab {
            background-color: var(--background-color);
            color: var(--on-surface-variant-color);
            border: 1px solid var(--outline-color);
            padding: 6px 12px;
            border-radius: var(--border-radius-lg);
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        .category-tab:hover {
            background-color: var(--category-tab-hover-bg);
            border-color: var(--accent-color);
            color: var(--primary-color);
        }
        .category-tab.active {
            background-color: var(--primary-color);
            color: var(--category-tab-active-text);
            border-color: var(--primary-color);
            font-weight: 500;
        }


        #statusMessagesContainer {
            padding: 0 16px; 
            margin-top: 10px; 
        }
        .status-message {
            padding: 10px 15px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
            font-size: 0.9em;
            opacity: 1;
            transition: opacity 0.3s ease-out;
            border: 1px solid transparent;
        }
        .status-message.error {
            background-color: var(--status-error-bg);
            color: var(--danger-color);
            border-color: var(--status-error-border);
        }
        .status-message.success {
            background-color: var(--status-success-bg);
            color: var(--secondary-color);
            border-color: var(--status-success-border);
        }
        .status-message.info {
            background-color: var(--status-info-bg);
            color: var(--primary-color);
            border-color: var(--status-info-border);
        }

        #groceryListContainer {
            padding-top: 10px;
        }
        .empty-list-message {
            text-align: center;
            color: var(--on-surface-variant-color);
            padding: 40px 20px;
            font-size: 1.1em;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        .empty-list-message .material-icons-sharp {
            font-size: 3em;
            color: var(--outline-color);
        }


        .category-section {
            margin: 0 12px 12px 12px;
            background-color: var(--surface-color); 
            border-radius: var(--border-radius-md);
            border: 1px solid var(--outline-color);
            animation: fadeInItem 0.4s ease-out;
        }
        @keyframes fadeInItem { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid transparent;
            transition: background-color 0.2s;
        }
        .category-header:hover {
            background-color: var(--hover-bg-light);
        }
        .category-header.active {
             border-bottom-color: var(--outline-color);
        }
         .category-header.active.no-items {
            border-bottom-color: transparent;
         }
        .category-header .category-name-icon {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            color: var(--on-surface-color);
        }
        .category-header .category-name-icon .material-icons-sharp { 
            font-size: 1.3em;
            color: var(--primary-color);
        }
        .category-header .arrow .material-icons-sharp {
            color: var(--on-surface-variant-color);
            transition: transform 0.2s ease-out;
        }
        .category-header.active .arrow .material-icons-sharp {
            transform: rotate(180deg);
        }
        
        .category-items {
            list-style: none;
            padding: 0;
            margin: 0;
            display: none;
        }

        .grocery-item {
            display: flex;
            align-items: center;
            padding: 10px 16px;
            border-bottom: 1px solid var(--outline-color);
            animation: fadeInItem 0.3s ease-out;
        }
        .grocery-item:last-child {
            border-bottom: none;
        }
        .grocery-item.purchased .item-name,
        .grocery-item.purchased .item-quantity-unit {
            text-decoration: line-through;
            color: var(--on-surface-variant-color);
            opacity: 0.7;
        }
         .grocery-item.purchased .item-icon-list .material-icons-sharp {
            color: var(--secondary-color);
         }


        .grocery-item .checkbox-container {
            margin-right: 12px;
            display: flex;
            align-items: center;
        }
        .grocery-item .checkbox-container input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--primary-color);
        }
        
        .item-main-content {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
        }
        .item-main-content .item-icon-list .material-icons-sharp { 
            color: var(--primary-color);
            font-size: 1.5em;
            opacity: 0.85;
        }
        .item-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .item-name {
            font-weight: 500;
            color: var(--on-surface-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .item-quantity-unit {
            font-size: 0.85em;
            color: var(--on-surface-variant-color);
        }

        .grocery-item .delete-btn {
            background: none;
            border: none;
            color: var(--danger-color);
            cursor: pointer;
            padding: 8px;
            margin-left: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .grocery-item .delete-btn:hover {
            background-color: rgba(var(--danger-color-rgb), 0.1);
        }
        .grocery-item .delete-btn .material-icons-sharp {
            font-size: 1.25em;
        }

        .purchased-section {
            margin-top: 20px;
            padding: 0 12px;
        }
        .purchased-section h2 {
            font-size: 1.2em;
            font-weight: 500;
            color: var(--on-surface-color);
            margin-bottom: 10px;
            padding: 8px 4px;
            border-bottom: 1px solid var(--outline-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
         .purchased-section h2 .material-icons-sharp {
            color: var(--secondary-color);
         }
        .purchased-section ul { list-style: none; padding: 0; margin: 0; }


        .empty-category-message {
            text-align: center;
            color: var(--on-surface-variant-color);
            padding: 20px;
            font-size: 0.9em;
            font-style: italic;
        }

        .permission-prompt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0s 0.3s;
        }
        html.dark-mode .permission-prompt-overlay {
            background-color: rgba(0,0,0,0.7);
        }
        .permission-prompt-overlay.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s;
        }
        .permission-prompt {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: var(--border-radius-md);
            box-shadow: var(--box-shadow-strong);
            text-align: center;
            max-width: 90%;
            width: 350px;
        }
        .permission-prompt h3 {
            margin-bottom: 12px;
            color: var(--on-surface-color);
        }
        .permission-prompt p {
            margin-bottom: 20px;
            font-size: 0.9em;
            color: var(--on-surface-variant-color);
        }
        .permission-prompt-actions button {
            padding: 10px 16px;
            border-radius: var(--border-radius-md);
            border: none;
            cursor: pointer;
            font-weight: 500;
            margin: 0 5px;
            min-width: 100px;
        }
        .permission-prompt-actions .allow-btn {
            background-color: var(--primary-color);
            color: var(--category-tab-active-text);
        }
         .permission-prompt-actions .deny-btn {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--outline-color);
        }

    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <h1>Smart Grocery Assistant</h1>
            <button id="darkModeToggle" class="theme-toggle-btn" title="Toggle Dark Mode">
                <span class="material-icons-sharp">brightness_4</span>
            </button>
        </header>

        <div class="budget-area">
            <label for="budgetAmountInput">Set Budget:</label>
            <input type="number" id="budgetAmountInput" placeholder="0.00" min="0" step="1">
            <span id="totalCostDisplay">Total: ₹0.00</span>
            <span id="budgetStatusDisplay"></span>
        </div>

        <div class="input-area-wrapper">
            <div class="input-bar">
                <div class="input-field-container">
                    <input type="text" id="mainItemInput" placeholder="Add an item...">
                    <button class="voice-input-btn" id="voiceInputBtnInside" title="Add by Voice">
                        <span class="material-icons-sharp">mic</span>
                    </button>
                </div>
                <button class="add-item-btn-main" id="mainAddBtn" title="Add Item">
                    <span class="material-icons-sharp">add</span> Add
                </button>
            </div>

            <div class="advanced-input-options" id="advancedInputOptions">
                <div class="options-grid">
                    <div class="option-group">
                        <label for="itemQuantityInput">Quantity</label>
                        <input type="number" id="itemQuantityInput" value="1" min="0.1" step="0.1">
                    </div>
                    <div class="option-group">
                        <label for="itemUnitSelect">Unit</label>
                        <select id="itemUnitSelect">
                            <option value="pcs">pcs</option>
                            <option value="kg">kg</option><option value="g">g</option>
                            <option value="litre">litre</option><option value="ml">ml</option>
                            <option value="dozen">dozen</option><option value="pack">pack</option>
                            <option value="bottle">bottle</option><option value="can">can</option>
                            <option value="item">item</option>
                        </select>
                    </div>
                    <div class="option-group">
                        <label for="itemPriceInput">Price (per unit)</label>
                        <input type="number" id="itemPriceInput" value="0" min="0" step="0.01">
                    </div>
                </div>
                <div class="category-suggestion-tabs">
                    <label>Category (Tap to select)</label>
                    <div class="tabs-container" id="categoryTabsContainer"></div>
                    <input type="hidden" id="selectedCategoryHiddenInput" value="Other"> 
                </div>
            </div>
        </div>
        
        <div id="statusMessagesContainer"></div>

        <main class="app-content">
            <div id="groceryListContainer">
                 {/* Empty list message will be shown here by JS if needed */}
            </div>
            <div class="purchased-section" id="purchasedListContainer"></div>
        </main>
    </div>

    <div class="permission-prompt-overlay" id="micPermissionOverlay">
        <div class="permission-prompt">
            <h3>Microphone Access</h3>
            <p>This app needs access to your microphone to enable voice input for adding grocery items.</p>
            <div class="permission-prompt-actions">
                <button class="deny-btn" id="denyMicPermissionBtn">Not now</button>
                <button class="allow-btn" id="allowMicPermissionBtn">Allow</button>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const mainItemInput = document.getElementById('mainItemInput');
        const voiceInputBtnInside = document.getElementById('voiceInputBtnInside');
        const mainAddBtn = document.getElementById('mainAddBtn');
        
        const advancedInputOptionsDiv = document.getElementById('advancedInputOptions');
        const itemQuantityInput = document.getElementById('itemQuantityInput');
        const itemUnitSelect = document.getElementById('itemUnitSelect');
        const itemPriceInput = document.getElementById('itemPriceInput');
        const categoryTabsContainer = document.getElementById('categoryTabsContainer');
        const selectedCategoryHiddenInput = document.getElementById('selectedCategoryHiddenInput');

        const statusMessagesContainer = document.getElementById('statusMessagesContainer');
        const groceryListContainer = document.getElementById('groceryListContainer');
        const purchasedListContainer = document.getElementById('purchasedListContainer');

        const micPermissionOverlay = document.getElementById('micPermissionOverlay');
        const allowMicPermissionBtn = document.getElementById('allowMicPermissionBtn');
        const denyMicPermissionBtn = document.getElementById('denyMicPermissionBtn');

        const darkModeToggle = document.getElementById('darkModeToggle');
        const budgetAmountInput = document.getElementById('budgetAmountInput');
        const totalCostDisplay = document.getElementById('totalCostDisplay');
        const budgetStatusDisplay = document.getElementById('budgetStatusDisplay');


        // --- App State & Config ---
        let groceryItems = []; 
        let isListening = false;
        let currentDetectedCategory = 'Other';
        let hideAdvancedOptionsTimeout; 
        let recognition; 
        let budgetExceededNotified = false; 
        let audioCtx; 

        const categoryIconsMaterial = {
            'Vegetables': 'local_florist', 'Fruits': 'apple', 'Dairy': 'kitchen', 'Bakery': 'bakery_dining',
            'Protein': 'egg_alt', 'Meat': 'set_meal', 'Seafood': 'phishing',
            'Grains': 'grain', 'Pasta & Rice': 'rice_bowl', 'Canned Goods': 'food_bank',
            'Pantry': 'inventory_2', 'Condiments & Sauces': 'restaurant', 'Oils & Vinegars': 'oil_barrel',
            'Spices': 'soup_kitchen', 'Baking': 'cake',
            'Frozen': 'ac_unit', 'Beverages': 'local_bar', 'Coffee & Tea': 'emoji_food_beverage', 'Juices': 'local_cafe', 'Water': 'water_drop',
            'Snacks': 'icecream', 'Chips & Crackers': 'cookie', 'Sweets': 'candy',
            'Household': 'home_work', 'Cleaning': 'cleaning_services', 'Paper Goods': 'article',
            'Personal Care': 'spa', 'Health & Beauty': 'health_and_safety',
            'Baby': 'child_care', 'Pets': 'pets', 'Pharmacy': 'medication', 'Alcohol': 'wine_bar',
            'International Foods': 'public', 'Breakfast & Cereal': 'breakfast_dining',
            'Deli': 'room_service', 'Organic': 'eco', 'Other': 'shopping_cart'
        };
        const defaultCategories = Object.keys(categoryIconsMaterial);
        defaultCategories.forEach(cat => { 
            if (!categoryIconsMaterial[cat]) categoryIconsMaterial[cat] = 'label'; 
        });
        const unitKeywords = { 
            'kg': ['kg', 'kilogram', 'kilograms'], 'g': ['g', 'gram', 'grams'],
            'litre': ['l', 'litre', 'liter', 'litres', 'liters'], 'ml': ['ml', 'millilitre', 'milliliter', 'millilitres', 'milliliters'],
            'pcs': ['pcs', 'pc', 'piece', 'pieces', 'unit', 'units'], 'dozen': ['dozen', 'dozens'],
            'pack': ['pack', 'packs', 'package', 'packages'], 'bottle': ['bottle', 'bottles'],
            'can': ['can', 'cans'], 'item': ['item', 'items']
        };
        const categoryKeywords = { 
            'Fruits': ['apple', 'banana', 'orange', 'mango', 'grape', 'strawberry', 'blueberry', 'raspberry', 'watermelon', 'melon', 'pear', 'peach', 'plum', 'cherry', 'kiwi', 'avocado', 'lime', 'lemon', 'pineapple', 'pomegranate'],
            'Vegetables': ['carrot', 'broccoli', 'spinach', 'potato', 'onion', 'tomato', 'garlic', 'cucumber', 'lettuce', 'cabbage', 'cauliflower', 'bell pepper', 'chilli', 'eggplant', 'zucchini', 'celery', 'asparagus', 'mushroom', 'corn', 'peas', 'beans', 'ginger', 'radish', 'beetroot', 'kale', 'pumpkin', 'sweet potato', 'capsicum', 'aubergine'],
            'Dairy': ['milk', 'cheese', 'yogurt', 'butter', 'cream', 'sour cream', 'cottage cheese', 'ghee', 'paneer', 'lassi', 'buttermilk'],
            'Bakery': ['bread', 'baguette', 'croissant', 'muffin', 'cake', 'donut', 'cookies', 'biscuit', 'pie', 'pastry', 'bagel', 'bun'],
            'Protein': ['egg', 'eggs', 'tofu', 'tempeh', 'seitan', 'protein powder', 'lentils', 'chickpeas', 'dal'],
            'Meat': ['chicken', 'beef', 'pork', 'lamb', 'turkey', 'sausage', 'bacon', 'ham', 'steak', 'mince', 'ground meat', 'mutton'],
            'Seafood': ['fish', 'salmon', 'tuna', 'shrimp', 'prawn', 'crab', 'lobster', 'oyster', 'mussel', 'scallop', 'cod', 'sardines'],
            'Grains': ['rice', 'oats', 'quinoa', 'barley', 'couscous', 'cereal', 'flour', 'wheat', 'cornmeal', 'semolina', 'buckwheat', 'atta', 'besan', 'rava', 'sooji'],
            'Pasta & Rice': ['pasta', 'spaghetti', 'macaroni', 'fettuccine', 'penne', 'lasagna', 'noodle', 'noodles', 'vermicelli', 'basmati', 'jasmine rice', 'brown rice'],
            'Pantry': ['sugar', 'salt', 'baking soda', 'baking powder', 'yeast', 'stock', 'bouillon', 'honey', 'maple syrup'],
            'Oils & Vinegars': ['oil', 'vinegar', 'olive oil', 'coconut oil', 'vegetable oil', 'ghee'], // Ghee can be pantry or oil
            'Canned Goods': ['canned tomatoes', 'canned beans', 'canned corn', 'canned tuna', 'canned soup', 'canned fruit', 'canned vegetables', 'coconut milk'],
            'Condiments & Sauces': ['ketchup', 'mustard', 'mayonnaise', 'soy sauce', 'hot sauce', 'bbq sauce', 'salsa', 'dressing', 'jam', 'jelly', 'peanut butter', 'pickle', 'chutney', 'relish', 'tahini', 'pesto'],
            'Spices': ['pepper', 'turmeric', 'cumin', 'coriander', 'paprika', 'oregano', 'basil', 'cinnamon', 'nutmeg', 'vanilla extract', 'chili powder', 'garam masala', 'cardamom', 'cloves', 'ginger powder', 'garlic powder'],
            'Frozen': ['frozen pizza', 'ice cream', 'frozen vegetables', 'frozen fruit', 'frozen meals', 'frozen fries', 'frozen peas', 'sorbet', 'gelato'],
            'Beverages': ['soda', 'juice', 'water', 'tea', 'coffee', 'milkshake', 'smoothie', 'energy drink', 'soft drink', 'lemonade', 'iced tea'],
            'Coffee & Tea': ['coffee beans', 'ground coffee', 'instant coffee', 'tea bags', 'loose tea', 'herbal tea', 'green tea', 'black tea'],
            'Snacks': ['chips', 'crisps', 'popcorn', 'pretzels', 'nuts', 'seeds', 'dried fruit', 'chocolate bar', 'candy', 'crackers', 'granola bar', 'protein bar', 'fruit snacks', 'biscuits'],
            'Household': ['toilet paper', 'paper towels', 'tissues', 'trash bags', 'aluminum foil', 'plastic wrap', 'ziploc bags', 'batteries', 'light bulbs', 'cling film', 'kitchen roll'],
            'Cleaning': ['detergent', 'dish soap', 'soap', 'cleaner', 'bleach', 'sponge', 'disinfectant', 'glass cleaner', 'laundry detergent', 'fabric softener', 'scourer', 'all-purpose cleaner', 'floor cleaner'],
            'Personal Care': ['shampoo', 'conditioner', 'body wash', 'toothpaste', 'toothbrush', 'deodorant', 'lotion', 'sunscreen', 'razor', 'shaving cream', 'feminine hygiene', 'face wash', 'mouthwash', 'soap bar', 'hand sanitizer'],
            'Baby': ['diapers', 'wipes', 'baby food', 'formula', 'nappies', 'baby lotion', 'baby powder'],
            'Pets': ['pet food', 'cat food', 'dog food', 'litter', 'bird seed', 'fish food', 'pet treats'],
            'Pharmacy': ['pain reliever', 'band-aid', 'antiseptic', 'vitamins', 'medicine', 'cough syrup', 'plasters', 'first aid'],
            'Alcohol': ['beer', 'wine', 'vodka', 'whiskey', 'rum', 'gin', 'liqueur', 'cider', 'spirits']
        };

        // New: For automatic unit suggestion
        const itemUnitSuggestions = {
            'milk': 'litre', 'juice': 'litre', 'water': 'litre', 'soda': 'litre', 'lassi': 'litre', 'buttermilk': 'litre',
            'apple': 'pcs', 'apples': 'kg', 'banana': 'dozen', 'bananas': 'dozen', 'orange': 'pcs', 'oranges': 'kg', 
            'mango': 'pcs', 'mangoes': 'kg', 'grape': 'kg', 'grapes': 'kg', 'lemon': 'pcs', 'lemons': 'pcs',
            'potato': 'kg', 'onion': 'kg', 'tomato': 'kg', 'carrot': 'kg', 'ginger': 'g', 'garlic': 'g',
            'broccoli': 'pcs', 'cabbage': 'pcs', 'cauliflower': 'pcs', 'spinach': 'pack', 'coriander': 'pack', 'mint': 'pack',
            'rice': 'kg', 'flour': 'kg', 'sugar': 'kg', 'salt': 'kg', 'dal': 'kg', 'atta': 'kg', 'besan': 'kg', 'rava': 'kg', 'sooji': 'kg', 'poha': 'kg',
            'bread': 'pack', 'butter': 'pack', 'cheese': 'pack', 'yogurt': 'pack', 'paneer': 'pack', 'curd': 'pack',
            'egg': 'pcs', 'eggs': 'dozen',
            'oil': 'litre', 'ghee': 'litre',
            'soap': 'pcs', 'shampoo': 'bottle', 'toothpaste': 'pcs', 'detergent': 'kg', 'dishwash': 'bottle',
            'tea': 'pack', 'coffee': 'pack', 'biscuit': 'pack', 'biscuits': 'pack', 'chips': 'pack'
        };


        // --- Budget & Total Cost ---
        function playBudgetExceededSound() {
            if (!audioCtx && (window.AudioContext || window.webkitAudioContext)) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (!audioCtx) return; 
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.type = 'sine'; 
            oscillator.frequency.setValueAtTime(660, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime); 
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + 0.3);
        }

        function calculateAndDisplayTotalCost() {
            let currentBudget = parseFloat(budgetAmountInput.value) || 0;
            let totalCost = 0;
            groceryItems.forEach(item => {
                if (!item.purchased) {
                    totalCost += (parseFloat(item.quantity) * parseFloat(item.price));
                }
            });
            if (totalCostDisplay) totalCostDisplay.textContent = `Total: ₹${totalCost.toFixed(2)}`;

            if (budgetStatusDisplay) {
                if (currentBudget > 0) {
                    if (totalCost > currentBudget) {
                        budgetStatusDisplay.textContent = `Over: ₹${(totalCost - currentBudget).toFixed(2)}`;
                        budgetStatusDisplay.style.color = 'var(--danger-color)';
                        if (!budgetExceededNotified) {
                            playBudgetExceededSound();
                            budgetExceededNotified = true;
                        }
                    } else {
                        budgetStatusDisplay.textContent = `Left: ₹${(currentBudget - totalCost).toFixed(2)}`;
                        budgetStatusDisplay.style.color = 'var(--secondary-color)';
                        budgetExceededNotified = false; 
                    }
                } else {
                    budgetStatusDisplay.textContent = '';
                    budgetExceededNotified = false;
                }
            }
            if (budgetAmountInput) localStorage.setItem('smartGroceryBudget', budgetAmountInput.value);
        }


        // --- Dark Mode ---
        const htmlElement = document.documentElement;
        function setDarkMode(isDark) {
            if (isDark) {
                htmlElement.classList.add('dark-mode');
                if(darkModeToggle) darkModeToggle.innerHTML = '<span class="material-icons-sharp">wb_sunny</span>';
                if(darkModeToggle) darkModeToggle.title = "Toggle Light Mode";
                localStorage.setItem('darkMode', 'enabled');
            } else {
                htmlElement.classList.remove('dark-mode');
                if(darkModeToggle) darkModeToggle.innerHTML = '<span class="material-icons-sharp">brightness_4</span>';
                if(darkModeToggle) darkModeToggle.title = "Toggle Dark Mode";
                localStorage.setItem('darkMode', 'disabled');
            }
        }

        // --- Microphone Permission Handling ---
        async function checkAndRequestMicPermission(isUserInitiated = false) {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showStatusMessage("Microphone access not supported by this browser.", "error");
                return false;
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop());
                if (micPermissionOverlay) micPermissionOverlay.classList.remove('visible');
                return true;
            } catch (err) {
                console.error("Microphone permission error:", err);
                if (micPermissionOverlay) micPermissionOverlay.classList.remove('visible');
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    if(isUserInitiated) showStatusMessage("Microphone permission denied. Enable it in browser settings for voice input.", "error", 6000);
                } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') {
                     showStatusMessage("No microphone found on this device.", "error");
                } else {
                    showStatusMessage("Could not access microphone: " + err.message, "error");
                }
                return false;
            }
        }
        
        function resetMicPermissionPrompt() {
            if(micPermissionOverlay) {
                micPermissionOverlay.querySelector('h3').textContent = "Microphone Access";
                micPermissionOverlay.querySelector('p').textContent = "This app needs access to your microphone to enable voice input for adding grocery items.";
                const allowBtn = micPermissionOverlay.querySelector('#allowMicPermissionBtn');
                if(allowBtn) allowBtn.style.display = 'inline-block';
                const denyBtn = micPermissionOverlay.querySelector('#denyMicPermissionBtn');
                if(denyBtn) denyBtn.textContent = 'Not now';
            }
        }


        if(allowMicPermissionBtn) allowMicPermissionBtn.addEventListener('click', async () => {
            if(micPermissionOverlay) micPermissionOverlay.classList.remove('visible');
            resetMicPermissionPrompt();
            const permissionGranted = await checkAndRequestMicPermission(true);
            if (permissionGranted) {
                startSpeechRecognition();
            }
        });

        if(denyMicPermissionBtn) denyMicPermissionBtn.addEventListener('click', () => {
            if(micPermissionOverlay) micPermissionOverlay.classList.remove('visible');
            resetMicPermissionPrompt();
            showStatusMessage("Voice input disabled as microphone access was not granted.", "info", 5000);
        });

        async function ensureMicPermissionAndStartSpeech() {
            if (!SpeechRecognition) { return; }
            if (typeof navigator.permissions === 'undefined') { 
                 const permissionGranted = await checkAndRequestMicPermission(true);
                 if(permissionGranted) startSpeechRecognition();
                 return;
            }

            try {
                const permissionStatus = await navigator.permissions.query({ name: 'microphone' });
                if (permissionStatus.state === 'granted') {
                    startSpeechRecognition();
                } else if (permissionStatus.state === 'prompt') {
                    resetMicPermissionPrompt();
                    if(micPermissionOverlay) micPermissionOverlay.classList.add('visible');
                } else { 
                    showStatusMessage("Mic permission denied. Please enable in browser settings & refresh.", "error", 6000);
                    if(micPermissionOverlay) {
                        micPermissionOverlay.querySelector('h3').textContent = "Permission Denied";
                        micPermissionOverlay.querySelector('p').textContent = "Microphone access is denied. To use voice input, please go to your browser's site settings and allow microphone access for this page, then refresh.";
                        micPermissionOverlay.querySelector('#allowMicPermissionBtn').style.display = 'none';
                        micPermissionOverlay.querySelector('#denyMicPermissionBtn').textContent = 'Okay';
                        micPermissionOverlay.classList.add('visible');
                    }
                }
                permissionStatus.onchange = () => {
                    if (micPermissionOverlay) micPermissionOverlay.classList.remove('visible');
                    resetMicPermissionPrompt();
                    if (permissionStatus.state === 'granted') { /* ... */ } 
                    else if (permissionStatus.state === 'denied') {
                        showStatusMessage("Mic permission denied. Please enable in browser settings & refresh.", "error", 6000);
                    }
                };
            } catch (error) { 
                console.warn("Permissions API error or not fully supported for 'microphone':", error);
                resetMicPermissionPrompt();
                if(micPermissionOverlay) micPermissionOverlay.classList.add('visible');
            }
        }

        // --- Speech Recognition ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let finalTranscriptProcessed = false; 
        
        function initializeSpeechRecognition() { 
            if (!SpeechRecognition) return;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = navigator.language || 'en-US';
            recognition.interimResults = true; 
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                if(voiceInputBtnInside) voiceInputBtnInside.classList.add('listening');
                if(voiceInputBtnInside) voiceInputBtnInside.title = "Listening... (Click to stop)";
                showStatusMessage("Listening...", "info", 2500);
                if (mainItemInput) mainItemInput.placeholder = "Listening... say your item";
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                if (mainItemInput) mainItemInput.value = finalTranscript || interimTranscript; 

                if (finalTranscript) {
                    processInput(finalTranscript.trim(), true); 
                }
            };

            recognition.onend = () => {
                isListening = false;
                if(voiceInputBtnInside) voiceInputBtnInside.classList.remove('listening');
                if(voiceInputBtnInside) voiceInputBtnInside.title = "Add by Voice";
                if (mainItemInput) mainItemInput.placeholder = "Add an item...";
                finalTranscriptProcessed = false; 
            };


            recognition.onerror = (event) => {
                console.error("Speech recognition error:", event.error);
                isListening = false;
                if(voiceInputBtnInside) voiceInputBtnInside.classList.remove('listening');
                if(voiceInputBtnInside) voiceInputBtnInside.title = "Add by Voice";
                if (mainItemInput) mainItemInput.placeholder = "Add an item...";

                if (event.error === 'no-speech') {
                    showStatusMessage("No speech detected. Please try again.", "info");
                } else if (event.error === 'audio-capture') {
                    showStatusMessage("Audio capture error. Please check your microphone.", "error");
                } else if (event.error === 'not-allowed') {
                    showStatusMessage("Microphone access was denied. Please enable it in browser settings.", "error");
                } else if (event.error === 'network') {
                    showStatusMessage("A network error occurred with the speech service. Please check your connection.", "error");
                } else {
                    showStatusMessage("Speech recognition error: " + event.error, "error");
                }
            };
        }
        function startSpeechRecognition() { 
            if (!recognition) initializeSpeechRecognition();
             if (!recognition) {
                 showStatusMessage("Speech input is not supported by your browser.", "error");
                 return;
             }
            if (isListening) {
                recognition.stop();
                return;
            }
            try {
                if (mainItemInput) mainItemInput.value = ''; 
                if (mainItemInput) mainItemInput.focus();
                recognition.start();
            } catch (e) {
                console.error("Error on recognition.start():", e);
                if (e.name === 'InvalidStateError') {
                    showStatusMessage("Mic busy. Please wait a moment and try again.", "info");
                } else {
                    showStatusMessage("Mic start error. Try again or check permissions.", "error");
                }
                isListening = false; 
                if (voiceInputBtnInside) voiceInputBtnInside.classList.remove('listening');
            }
        }
        if (SpeechRecognition) { initializeSpeechRecognition(); } 
        else { if (voiceInputBtnInside) voiceInputBtnInside.style.display = 'none'; console.warn("Speech Recognition API not supported."); }


        // --- UI Interaction ---
        function updateAdvancedOptionsVisibility(show, forceHide = false) { 
            if(!advancedInputOptionsDiv) return;
            if (forceHide) {
                advancedInputOptionsDiv.style.display = 'none';
                return;
            }
            if (show) {
                advancedInputOptionsDiv.style.display = 'block';
            } else {
                hideAdvancedOptionsTimeout = setTimeout(() => {
                    if (document.activeElement !== mainItemInput && 
                        !advancedInputOptionsDiv.contains(document.activeElement) &&
                        Array.from(categoryTabsContainer.children).indexOf(document.activeElement) === -1 ) {
                        advancedInputOptionsDiv.style.display = 'none';
                    }
                }, 200);
            }
        }
        
        function suggestUnitFromInput(itemName) { // New function
            if (!itemName || itemName.trim() === '' || !itemUnitSelect) return;
            const lowerItemName = itemName.toLowerCase();

            for (const keyword in itemUnitSuggestions) {
                const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`);
                if (regex.test(lowerItemName)) {
                    const suggestedUnit = itemUnitSuggestions[keyword];
                    const unitExists = Array.from(itemUnitSelect.options).some(option => option.value === suggestedUnit);
                    if (unitExists) {
                        itemUnitSelect.value = suggestedUnit;
                        return; 
                    }
                }
            }
        }
        
        if(mainItemInput) { 
            mainItemInput.addEventListener('focus', () => {
                clearTimeout(hideAdvancedOptionsTimeout);
                const detectedCategory = detectCategoryFromInput(mainItemInput.value);
                renderCategoryTabs(detectedCategory);
                suggestUnitFromInput(mainItemInput.value); // Suggest unit on focus too
                updateAdvancedOptionsVisibility(true);
            });
            mainItemInput.addEventListener('blur', () => {
                updateAdvancedOptionsVisibility(false);
            });
            mainItemInput.addEventListener('input', () => {
                clearTimeout(hideAdvancedOptionsTimeout); 
                updateAdvancedOptionsVisibility(true);
                const itemName = mainItemInput.value;
                const detectedCategory = detectCategoryFromInput(itemName);
                renderCategoryTabs(detectedCategory);
                suggestUnitFromInput(itemName); // New: Suggest unit as user types
            });
        }
        if(advancedInputOptionsDiv) { 
            advancedInputOptionsDiv.addEventListener('focusin', () => clearTimeout(hideAdvancedOptionsTimeout));
            advancedInputOptionsDiv.addEventListener('focusout', (e) => {
                 if (!advancedInputOptionsDiv.contains(e.relatedTarget) && e.relatedTarget !== mainItemInput) {
                    updateAdvancedOptionsVisibility(false);
                }
            });
        }


        function detectCategoryFromInput(itemName) { 
            if (!itemName || itemName.trim() === '') return 'Other';
            const lowerItemName = itemName.toLowerCase();
            for (const category in categoryKeywords) {
                for (const keyword of categoryKeywords[category]) {
                    const regex = new RegExp(`\\b${keyword.toLowerCase().replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}\\b`); 
                    if (regex.test(lowerItemName)) {
                        return category;
                    }
                }
            }
            return 'Other';
        }
        function renderCategoryTabs(suggestedCategory) { 
            if(!categoryTabsContainer || !selectedCategoryHiddenInput) return;
            categoryTabsContainer.innerHTML = '';
            selectedCategoryHiddenInput.value = suggestedCategory; 
            currentDetectedCategory = suggestedCategory;

            let categoriesToShow = [suggestedCategory];
            defaultCategories.forEach(cat => {
                if (cat !== suggestedCategory && !categoriesToShow.includes(cat)) categoriesToShow.push(cat);
            });
            categoriesToShow = categoriesToShow.slice(0, 8); 

            categoriesToShow.forEach(category => {
                const tab = document.createElement('button');
                tab.type = "button"; 
                tab.classList.add('category-tab');
                tab.textContent = category;
                tab.dataset.category = category;
                if (category === suggestedCategory) {
                    tab.classList.add('active');
                }
                tab.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    selectedCategoryHiddenInput.value = category;
                    currentDetectedCategory = category;
                    if(mainItemInput) mainItemInput.focus(); 
                });
                categoryTabsContainer.appendChild(tab);
            });
        }

        // --- Core Logic ---
        function showStatusMessage(message, type = 'info', duration = 3500) { 
            if(!statusMessagesContainer) return;
            const existingMessages = statusMessagesContainer.querySelectorAll(`.status-message.${type}, .status-message.info`);
            existingMessages.forEach(msg => msg.remove());

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('status-message', type);
            messageDiv.textContent = message;
            statusMessagesContainer.insertBefore(messageDiv, statusMessagesContainer.firstChild); 

            setTimeout(() => {
                messageDiv.style.opacity = '0';
                setTimeout(() => messageDiv.remove(), 300);
            }, duration);
        }

        function parseItemFromString(inputString) { 
            let name = inputString.trim();
            let quantity = parseFloat(itemQuantityInput.value) || 1; 
            let unit = itemUnitSelect.value || 'pcs';

            const allUnitKeywords = Object.values(unitKeywords).flat().join('|');
            const unitPattern = `(?:\\s*(${allUnitKeywords})\\b)`; 

            let match = name.match(new RegExp(`^\\s*(\\d*\\.?\\d+)?${unitPattern}\\s+(.+)$`, 'i'));
            if (match) {
                if (match[1]) quantity = parseFloat(match[1]); 
                unit = Object.keys(unitKeywords).find(key => unitKeywords[key].includes(match[2].toLowerCase())) || unit; 
                name = match[3].trim(); 
            } else {
                match = name.match(new RegExp(`^(.+?)\\s+(\\d*\\.?\\d+)?${unitPattern}\\s*$`, 'i'));
                if (match) {
                    name = match[1].trim(); 
                    if (match[2]) quantity = parseFloat(match[2]); 
                    unit = Object.keys(unitKeywords).find(key => unitKeywords[key].includes(match[3].toLowerCase())) || unit; 
                }
            }
            return { name, quantity, unit };
        }
        
        function getCategoryForItem(itemName) { 
            if (selectedCategoryHiddenInput.value && defaultCategories.includes(selectedCategoryHiddenInput.value)) {
                 return selectedCategoryHiddenInput.value;
            }
            return detectCategoryFromInput(itemName);
        }

        function processInput(inputValue, fromVoice = false) {
            const rawItemName = inputValue.trim();
            if (!rawItemName) {
                showStatusMessage("Please enter an item name.", "error");
                if(mainItemInput) mainItemInput.focus();
                return;
            }

            let parsedItem;
            if (!fromVoice && advancedInputOptionsDiv && advancedInputOptionsDiv.style.display === 'block') {
                 parsedItem = {
                    name: rawItemName,
                    quantity: parseFloat(itemQuantityInput.value) || 1,
                    unit: itemUnitSelect.value || 'pcs'
                };
            } else {
                parsedItem = parseItemFromString(rawItemName);
            }
            
            const price = parseFloat(itemPriceInput.value) || 0;
            const category = getCategoryForItem(parsedItem.name);

            const newItem = {
                id: Date.now() + Math.random(),
                name: parsedItem.name.charAt(0).toUpperCase() + parsedItem.name.slice(1),
                quantity: parsedItem.quantity,
                unit: parsedItem.unit,
                price: price, 
                category: category,
                purchased: false
            };

            addItemToList(newItem);
            if(mainItemInput) mainItemInput.value = ''; 
            if(itemQuantityInput) itemQuantityInput.value = '1'; 
            if(itemUnitSelect) itemUnitSelect.value = 'pcs'; // Reset unit to default
            if(itemPriceInput) itemPriceInput.value = '0'; 
            renderCategoryTabs('Other'); 
            updateAdvancedOptionsVisibility(false, true); // Hide advanced options after adding
            if(mainItemInput) mainItemInput.focus(); 
            showStatusMessage(`Added: ${newItem.name}`, "success");
            finalTranscriptProcessed = true;
        }

        function addItemToList(item) {
            groceryItems.unshift(item);
            saveList();
            renderList();
        }

        function toggleItemPurchased(itemId) {
            const itemIndex = groceryItems.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                groceryItems[itemIndex].purchased = !groceryItems[itemIndex].purchased;
                saveList();
                renderList();
            }
        }

        function deleteItem(itemId) {
            groceryItems = groceryItems.filter(i => i.id !== itemId);
            saveList();
            renderList();
            showStatusMessage("Item removed.", "info", 2000);
        }

        // --- Rendering ---
        function renderList() {
            if(!groceryListContainer || !purchasedListContainer) return;
            groceryListContainer.innerHTML = '';
            purchasedListContainer.innerHTML = '';
            const activeItems = groceryItems.filter(item => !item.purchased);
            const purchasedItems = groceryItems.filter(item => item.purchased);

            if (activeItems.length === 0 && purchasedItems.length === 0) {
                groceryListContainer.innerHTML = `
                    <div class="empty-list-message">
                        <span class="material-icons-sharp">list_alt</span>
                        <span>Your grocery list is empty.</span>
                        <p style="font-size:0.85em; color: var(--on-surface-variant-color);">Add items using the input field above.</p>
                    </div>`;
                purchasedListContainer.style.display = 'none';
            } else {
                const categoriesWithActiveItems = {}; 
                activeItems.forEach(item => {
                    if (!categoriesWithActiveItems[item.category]) {
                        categoriesWithActiveItems[item.category] = [];
                    }
                    categoriesWithActiveItems[item.category].push(item);
                });

                const sortedActiveCategoryNames = Object.keys(categoriesWithActiveItems).sort((a, b) => { 
                    const indexA = defaultCategories.indexOf(a);
                    const indexB = defaultCategories.indexOf(b);
                    if (indexA === -1 && indexB === -1) return a.localeCompare(b); 
                    if (indexA === -1) return 1; 
                    if (indexB === -1) return -1; 
                    return indexA - indexB;
                });


                if (sortedActiveCategoryNames.length > 0) {
                    sortedActiveCategoryNames.forEach(categoryName => {
                        const itemsInCategory = categoriesWithActiveItems[categoryName];
                        if (itemsInCategory.length > 0) {
                            const categorySection = createCategorySection(categoryName, itemsInCategory, true);
                            groceryListContainer.appendChild(categorySection);
                        }
                    });
                } else if (activeItems.length > 0) { 
                    const otherSection = createCategorySection('Other', activeItems, true);
                    groceryListContainer.appendChild(otherSection);
                }


                if (purchasedItems.length > 0) { 
                    purchasedListContainer.style.display = 'block';
                    const purchasedHeader = document.createElement('h2');
                    purchasedHeader.innerHTML = `<span class="material-icons-sharp">shopping_cart_checkout</span> Purchased Items (${purchasedItems.length})`;
                    purchasedHeader.style.cursor = 'pointer';
                    purchasedHeader.title = "Toggle purchased items visibility";
                    let purchasedOpen = localStorage.getItem('purchasedOpen') !== 'false'; 
                    if(!purchasedOpen) purchasedHeader.classList.add('collapsed-section');

                    const purchasedItemsList = document.createElement('ul');
                    purchasedItemsList.style.display = purchasedOpen ? 'block' : 'none';
                    purchasedItems.forEach(item => {
                        const listItem = createGroceryItemElement(item);
                        purchasedItemsList.appendChild(listItem);
                    });
                    
                    purchasedHeader.addEventListener('click', () => {
                        purchasedOpen = !purchasedOpen;
                        localStorage.setItem('purchasedOpen', purchasedOpen);
                        purchasedItemsList.style.display = purchasedOpen ? 'block' : 'none';
                        purchasedHeader.classList.toggle('collapsed-section', !purchasedOpen);
                    });
                    purchasedListContainer.appendChild(purchasedHeader);
                    purchasedListContainer.appendChild(purchasedItemsList);
                } else {
                    purchasedListContainer.style.display = 'none';
                }
            }
            
            document.querySelectorAll('.category-header').forEach(headerEl => { 
                headerEl.addEventListener('click', (e) => {
                    if (e.target.closest('.category-action-btn')) return;
                    const section = headerEl.closest('.category-section');
                    const categoryName = section.dataset.categoryName;
                    headerEl.classList.toggle('active');
                    const itemsContainer = headerEl.nextElementSibling;
                    const isActive = headerEl.classList.contains('active');
                    if (itemsContainer) {
                        itemsContainer.style.display = isActive ? 'block' : 'none';
                    }
                    localStorage.setItem(`category_${categoryName}_open`, isActive);
                });
            });
            calculateAndDisplayTotalCost(); 
        }

        function createCategorySection(categoryName, items, initiallyOpen = false) { 
            const section = document.createElement('div');
            section.classList.add('category-section');
            section.dataset.categoryName = categoryName;
            const header = document.createElement('div');
            header.classList.add('category-header');
            const storedStateOpen = localStorage.getItem(`category_${categoryName}_open`);
            let isOpen = initiallyOpen; 
            if (storedStateOpen !== null) {
                isOpen = storedStateOpen === 'true';
            }
            if (isOpen) header.classList.add('active');

            const nameIcon = document.createElement('div'); 
            nameIcon.classList.add('category-name-icon');
            const iconSpan = document.createElement('span');
            iconSpan.classList.add('material-icons-sharp');
            iconSpan.textContent = categoryIconsMaterial[categoryName] || 'label';
            nameIcon.appendChild(iconSpan);
            nameIcon.appendChild(document.createTextNode(` ${categoryName} (${items.length})`));
            header.appendChild(nameIcon);

            const arrow = document.createElement('div'); 
            arrow.classList.add('arrow');
            arrow.innerHTML = `<span class="material-icons-sharp">expand_more</span>`;
            header.appendChild(arrow);
            section.appendChild(header);

            const itemsList = document.createElement('ul'); 
            itemsList.classList.add('category-items');
            itemsList.style.display = isOpen ? 'block' : 'none';

            if (items.length === 0) {
                header.classList.add('no-items');
                const emptyMsg = document.createElement('p');
                emptyMsg.classList.add('empty-category-message');
                emptyMsg.textContent = 'No items in this category.';
                itemsList.appendChild(emptyMsg);
            } else {
                items.forEach(item => {
                    const listItem = createGroceryItemElement(item);
                    itemsList.appendChild(listItem);
                });
            }
            section.appendChild(itemsList);
            return section;
        }

        function createGroceryItemElement(item) { 
            const listItem = document.createElement('li');
            listItem.classList.add('grocery-item');
            listItem.dataset.itemId = item.id;
            if (item.purchased) listItem.classList.add('purchased');

            const checkboxContainer = document.createElement('div');
            checkboxContainer.classList.add('checkbox-container');
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.purchased;
            checkbox.id = `item-${item.id}`;
            checkbox.setAttribute('aria-label', `Mark ${item.name} as ${item.purchased ? 'not purchased' : 'purchased'}`);
            checkbox.addEventListener('change', () => toggleItemPurchased(item.id));
            checkboxContainer.appendChild(checkbox);
            
            const itemMainContent = document.createElement('div');
            itemMainContent.classList.add('item-main-content');
            const itemIconList = document.createElement('span');
            itemIconList.classList.add('item-icon-list');
            const itemIcon = document.createElement('span');
            itemIcon.classList.add('material-icons-sharp');
            itemIcon.textContent = item.purchased ? 'check_circle' : (categoryIconsMaterial[item.category] || 'label_important');
            itemIconList.appendChild(itemIcon);

            const itemDetails = document.createElement('div');
            itemDetails.classList.add('item-details');
            const itemNameSpan = document.createElement('span');
            itemNameSpan.classList.add('item-name');
            itemNameSpan.textContent = item.name;
            const itemQuantityUnitSpan = document.createElement('span');
            itemQuantityUnitSpan.classList.add('item-quantity-unit');
            itemQuantityUnitSpan.textContent = `${item.quantity} ${item.unit} (₹${parseFloat(item.price || 0).toFixed(2)} each)`;
            itemDetails.appendChild(itemNameSpan);
            itemDetails.appendChild(itemQuantityUnitSpan);
            itemMainContent.appendChild(itemIconList);
            itemMainContent.appendChild(itemDetails);

            const deleteBtn = document.createElement('button');
            deleteBtn.classList.add('delete-btn');
            deleteBtn.title = `Delete ${item.name}`;
            deleteBtn.setAttribute('aria-label', `Delete ${item.name}`);
            deleteBtn.innerHTML = `<span class="material-icons-sharp">delete_outline</span>`;
            deleteBtn.addEventListener('click', () => deleteItem(item.id));

            listItem.appendChild(checkboxContainer);
            listItem.appendChild(itemMainContent);
            listItem.appendChild(deleteBtn);
            return listItem;
        }

        // --- Event Listeners ---
        if(mainAddBtn) mainAddBtn.addEventListener('click', () => processInput(mainItemInput.value));
        if(mainItemInput) mainItemInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') { event.preventDefault(); processInput(mainItemInput.value); }
        });
        if(voiceInputBtnInside) voiceInputBtnInside.addEventListener('click', async () => {
            await ensureMicPermissionAndStartSpeech();
        });
        if(darkModeToggle) darkModeToggle.addEventListener('click', () => {
            setDarkMode(!htmlElement.classList.contains('dark-mode'));
        });
        if(budgetAmountInput) budgetAmountInput.addEventListener('input', calculateAndDisplayTotalCost);
        
        // --- Local Storage ---
        function saveList() {
            localStorage.setItem('smartGroceryList', JSON.stringify(groceryItems));
        }
        function loadList() {
            const storedItems = localStorage.getItem('smartGroceryList');
            if (storedItems) {
                try {
                    groceryItems = JSON.parse(storedItems);
                    if (!Array.isArray(groceryItems)) { groceryItems = []; localStorage.removeItem('smartGroceryList'); }
                } catch (e) { groceryItems = []; localStorage.removeItem('smartGroceryList'); console.error("Error parsing grocery list:", e); }
            }
            const storedBudget = localStorage.getItem('smartGroceryBudget');
            if (storedBudget && budgetAmountInput) {
                budgetAmountInput.value = storedBudget;
            }
            renderList();
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            const essentialElements = [ 
                mainItemInput, voiceInputBtnInside, mainAddBtn, advancedInputOptionsDiv,
                itemQuantityInput, itemUnitSelect, itemPriceInput, categoryTabsContainer, selectedCategoryHiddenInput,
                statusMessagesContainer, groceryListContainer, purchasedListContainer,
                micPermissionOverlay, allowMicPermissionBtn, denyMicPermissionBtn,
                darkModeToggle, budgetAmountInput, totalCostDisplay, budgetStatusDisplay
            ];
             if (essentialElements.some(el => !el)) {
                console.error("CRITICAL ERROR: One or more essential DOM elements not found.");
                const elementNames = [
                    "mainItemInput", "voiceInputBtnInside", "mainAddBtn", "advancedInputOptionsDiv", 
                    "itemQuantityInput", "itemUnitSelect", "itemPriceInput", "categoryTabsContainer", "selectedCategoryHiddenInput",
                    "statusMessagesContainer", "groceryListContainer", "purchasedListContainer", 
                    "micPermissionOverlay", "allowMicPermissionBtn", "denyMicPermissionBtn",
                    "darkModeToggle", "budgetAmountInput", "totalCostDisplay", "budgetStatusDisplay"
                ];
                essentialElements.forEach((el, index) => { if (!el) console.error(`Missing: ${elementNames[index]}`); });
                document.body.innerHTML = `<div style='padding:20px; text-align:center; color:red; font-family:sans-serif;'><h2>Application Error</h2><p>A critical part of the application interface could not be loaded.</p></div>`;
                return;
            }

            if (localStorage.getItem('darkMode') === 'enabled' ||
                (localStorage.getItem('darkMode') === null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                setDarkMode(true);
            } else {
                setDarkMode(false);
            }

            loadList(); 
            renderCategoryTabs('Other'); 
            updateAdvancedOptionsVisibility(false, true); 
        });
    </script>
</body>
</html>